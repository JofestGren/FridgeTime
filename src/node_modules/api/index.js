import request from 'superagent'

const appId = 'c28d3573';
const appKey = '411ca5342798527424d0aac10b9d542f'

let inredientsToMore = ``

const filterIngredient = (ingredient, parameters) => {
  let ingredientList = ``
  if (ingredient !== '') {
    const arrIngredients = ingredient.split(',')
    for (let i = 0; i < arrIngredients.length; i++) {
      let temp = arrIngredients[i].trim().replace(/ /ig, '+')
      ingredientList += `&${parameters}[]=${temp}` 
    }

    return ingredientList
  } else {
    return ingredientList
  }
}

const filterSearchById = (recipesArray) => {
  const recipe = recipesArray.ingredientLines
  let counter = 0
  let startNumber

  for (let j = 1; j < recipe.length; j++) {
    if (recipe[j] === recipe[j-1]) {
      if (!startNumber) {
        startNumber = j
      }
      counter++
    }
  }
  
  recipe.splice(startNumber, counter)
  
  return recipesArray
}

export const fetchRecipes = async (allowedIngredient, excludedIngredient) => {  
  const allowedIngredientList = filterIngredient(allowedIngredient, 'allowedIngredient')
  const excludedIngredientList = filterIngredient(excludedIngredient, 'excludedIngredient')

  const {body} = await request.get(
    `http://api.yummly.com/v1/api/recipes?_app_id=${appId}&_app_key=${appKey}${allowedIngredientList}${excludedIngredientList}&requirePictures=true`
  )

  if (body.matches.length !== 0)
    inredientsToMore = `${allowedIngredientList}${excludedIngredientList}`

  return body.matches
}

export const loadMoreRecipes = async ({offset}) => {
  const {body} = await request.get(
    `http://api.yummly.com/v1/api/recipes?_app_id=${appId}&_app_key=${appKey}${inredientsToMore}&requirePictures=true&maxResult=${offset}&start=${offset}`
  )

  return body.matches
}

export const fetchRecipeById = async id => {
  const {body} = await request.get(
    `http://api.yummly.com/v1/api/recipe/${id}?_app_id=${appId}&_app_key=${appKey}&requirePictures=true`
  )
  
  const filterRecipe = filterSearchById(body)

  return filterRecipe
}

export const basketCheckout = async (id) => {
  let recipesBasket = []

  for (let i = 0; i < id.length; i++) {
    const recipeId = id[i]
    const recipe = await fetchRecipeById(recipeId)
    recipesBasket[i] = recipe
  }

  return recipesBasket
}